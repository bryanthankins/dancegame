<!DOCTYPE html>
<html>

<head>
    <script src="lib/phaser.min.js"></script>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }
    </style>
    <meta name="viewport" content="initial-scale=1 user-scalable=no" />
</head>

<body>

    <script>


        var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create, update: update });

        function preload() {

            game.load.image('stage', 'assets/pics/stage.png');
            game.load.image('note', 'assets/sprites/musicnote.png');
            game.load.audio('song', ['assets/audio/space.mp3']);

            game.load.audio('start', ['assets/audio/button_start.wav']);
            game.load.audio('success', ['assets/audio/button_correct.wav']);
            game.load.audio('miss', ['assets/audio/button_fail.wav']);
            game.load.audio('end', ['assets/audio/dramatic.wav']);

            game.load.spritesheet('dancer', 'assets/sprites/dancer.png', 64, 64);
            game.load.image('arrow', 'assets/sprites/arrow.png');
            game.load.image('slidearrow', 'assets/sprites/slidearrow.png');
            game.load.bitmapFont('carrier_command', 'assets/fonts/carrier_command.png', 'assets/fonts/carrier_command.xml');


        }

        var back;
        var mummy;
        var dancer;
        var anim;
        var loopText;
        var slideButtonPressed = true;
        var timer;
        var failCounter = 0;
        var arrows;
        var note;
        var arrowInterval = 1.3;
        var bmpText;
        var bmpText2;
        var startText;
        var scoreText;
        var levelText;
        var currScore = 0;
        var arrowShownTime;
        var timeToClickArrow;
        var slideArrowShownTime;
        var timeToClickSlideArrow;
        var slideArrows;
        var currSlideArrow;
        var startSound;
        var successSound;
        var missSound;
        var endSound;
        var gameTimer;
        var gameRunning = false;
        var moveCounter = 0;

        function create() {
            // Game set-up
            gameTimer = game.time.time;
            game.input.maxPointers = 3;
            game.scale.pageAlignHorizontally = true;
            game.scale.pageAlignVertically = true;
            game.stage.backgroundColor = 0x000000;
            if (!game.device.desktop) {
                game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
                game.scale.pageAlignHorizontally = true;
                game.scale.pageAlignVertically = true;
                document.body.style.backgroundColor = '#000000';
            }

            // Add music
            music = game.add.audio('song', 0.5);
            startSound = game.add.audio('start');
            successSound = game.add.audio('success');
            missSound = game.add.audio('miss');
            endSound = game.add.audio('end');

            // // Background
            back = game.add.image(game.world.centerX, game.world.centerY, 'stage');
            back.anchor.setTo(0.5);
            back.smoothed = false;

            // // Add Text
            bmpText = game.add.bitmapText(this.world.centerX, this.world.centerY - 150, 'carrier_command', 'SOCIAL DISTANCE', 30);
            bmpText.smoothed = false;
            bmpText.anchor.setTo(0.5);

            bmpText2 = game.add.bitmapText(this.world.centerX, this.world.centerY - 100, 'carrier_command', 'Dancing', 25);
            bmpText2.anchor.setTo(0.5);
            bmpText2.smoothed = false;

            scoreText = game.add.bitmapText(this.world.centerX + 175, this.world.centerY - 275, 'carrier_command', 'Score: 0', 24);
            scoreText.anchor.setTo(0.5);
            scoreText.smoothed = false;
            scoreText.visible = false;

            levelText = game.add.bitmapText(this.world.centerX - 175, this.world.centerY - 275, 'carrier_command', 'Level: 1', 24);
            levelText.anchor.setTo(0.5);
            levelText.smoothed = false;
            levelText.visible = false;


            startText = this.add.bitmapText(this.world.centerX, this.world.centerY, 'carrier_command', 'Tap to Start', 24);
            startText.anchor.x = 0.5;
            this.add.tween(startText).to({ y: 275 }, 100).easing(Phaser.Easing.Bounce.Out).start();
            this.add.tween(startText).to({ angle: -2 }, 500).to({ angle: 2 }, 1000).to({ angle: 0 }, 500).loop().start();
            startText.inputEnabled = true;
            game.input.onDown.addOnce(startGame, this);

            // // Dancer
            dancer = game.add.sprite(this.world.centerX, this.world.centerY + 175, 'dancer', 5);
            dancer.anchor.setTo(0.5);
            dancer.scale.set(3);
            dancer.smoothed = false;
            dancer.animations.add('dance1', [0, 1, 2, 3, 4, 5, 6, 7]);
            dancer.animations.add('dance2', [8, 9, 10, 11, 12, 13, 14, 15, 16]);
            dancer.animations.add('dance3', [17, 18, 19, 20, 21, 22, 23, 24, 25]);
            dancer.animations.add('dance4', [26, 27, 28, 29, 30, 31, 32, 33, 34]);
            dancer.frame = 0; //happy frame

            // // Arrows
            arrows = game.add.group();
            arrows.create(this.world.centerX - 115, this.world.centerY + 150, 'arrow').angle = 180;
            arrows.create(this.world.centerX + 115, this.world.centerY + 150, 'arrow').angle = 0;
            arrows.create(this.world.centerX, this.world.centerY + 35, 'arrow').angle = -90;
            arrows.forEach(function (arrow) {
                arrow.anchor.setTo(0.5, 0.5);
                arrow.visible = false;
                arrow.smoothed = false;
                arrow.inputEnabled = true;
                arrow.events.onInputDown.add(arrowClick, this);

            });

            // // TODO: Add Slide arrows to group
            // slideArrows = game.add.group();
            // slideArrows.create(this.world.centerX - 205, this.world.centerY + 150, 'slidearrow').angle = 180;
            // slideArrows.create(this.world.centerX + 205, this.world.centerY + 150, 'slidearrow').angle = 0;    
            // slideArrows.forEach(function(arrow){
            //         arrow.anchor.setTo(0.5, 0.5);
            //         arrow.visible = false;
            //         arrow.smoothed = false;
            //         arrow.inputEnabled = true;
            //         arrow.events.onInputDown.add(slideArrowClick, this);

            // }); 

            // // Music note
            note = game.add.sprite(this.world.centerX - 265, this.world.centerY + 280, 'note');
            note.anchor.setTo(0.5);
            note.inputEnabled = true;
            note.events.onInputDown.add(noteClick, this);


        }

        function startGame() {

            //music.play();
            dancer.animations.play('dance' + game.rnd.integerInRange(1, 4), 10, true);
            back.inputEnabled = false;
            bmpText.visible = false;
            bmpText2.visible = false;
            startText.visible = false;
            scoreText.visible = true;
            levelText.visible = true;
            startSound.play();
            gameRunning = true;

        }

        function noteClick() {
            music.pause();
        }

        function endGame() {
            gameRunning = false
            var failText = game.add.bitmapText(game.world.centerX, game.world.centerY - 70, 'carrier_command', 'GAME OVER', 44);
            failText.anchor.x = 0.5;
            dancer.animations.stop(null, true);
            dancer.frame = 7; //sad frame
            endSound.play();
            music.pause();
            moveCounter = 0;

        }

        function runMissLogic() {
                failCounter += 1;
                var missText = game.add.bitmapText(game.world.centerX, game.world.centerY, 'carrier_command', getNegativePhrase(), 24);
                missText.anchor.setTo(0.5);
                missText.smoothed = false;

                game.add.tween(missText).to({ y: 0 }, 1500, Phaser.Easing.Linear.None, true);
                game.add.tween(missText).to({ alpha: 0 }, 1500, Phaser.Easing.Linear.None, true);
                game.add.tween(missText).to({ angle: -50 }, 500).to({ angle: 50 }, 1000).to({ angle: -50 }, 500).loop().start();

                missSound.play();
        }

        function hasVisibleArrows() {
            debugger;
           
        }

        function startNewMove() {
            moveCounter++;
            
            hasVisibleArrows = false;
            arrows.forEach(function (arrow) {
                if (arrow.visible) {
                    hasVisibleArrows = true;
                }
            });

            if (hasVisibleArrows) {
                runMissLogic();
                if (failCounter > 2) {
                    endGame();
                }
            }
            else {
                currScore += 10;
                scoreText.text = 'Score:' + currScore;
            }

            // Hide existing arrows in collection
            arrows.setAll('visible', false);

            // Get new random arrow and show
            var newArrow = arrows.getRandom();
            newArrow.visible = true;
            newArrow.shownTime = game.time.time;
        }

        // function slideArrowClick (slideArrow) {

        //     //hide  arrow
        //     timeToClickSlideArrow = game.time.elapsedSecondsSince(slideArrowShownTime);    
        //     if(timeToClickSlideArrow < 0.5)
        //         console.log("GREAT!");
        //     else if(timeToClickSlideArrow < 1)
        //         console.log("OK");
        //     else
        //         console.log("Poor");
        //     slideArrow.visible = false;
        //     slideButtonPressed = true;
        //     dancer.animations.play('dance' + game.rnd.integerInRange(1, 4),10,true);
        //     var slideOffset = 0;
        //     var rotateOffset = 0;
        //     if(slideArrow.angle == 0) {
        //         slideOffset = 200;
        //         rotateOffset = 15
        //     }
        //     else {
        //         slideOffset = -200;
        //         rotateOffset = -15
        //     }
        //     game.add.tween(dancer).to({x: game.world.centerX + slideOffset}, 500).to({x: game.world.centerX}, 500).start();    
        //     game.add.tween(dancer).to({angle: rotateOffset}, 500).to({angle: 2}, 500).to({angle: 0}, 500).start();

        // }


        function getPostivePhrase() {
            var positivePhrase = [
                "AWESOME! +50",
                "NICE! + 50",
                "Oh Yeah! +50",
                "Rock on! +50",
                "Woah! Nice! + 50",
                "Beast Mode! + 50"
            ];

            var randomNum = game.rnd.integerInRange(0, 5);
            return positivePhrase[randomNum];

        }


        function getNegativePhrase() {
            var positivePhrase = [
                "BOO! -25",
                "SAD! + 25",
                "Umm.....! -25",
                "Fail! -25",
                "You suck! -25",
                "Off beat! -25"
            ];

            var randomNum = game.rnd.integerInRange(0, 5);
            return positivePhrase[randomNum];

        }

        function arrowClick(arrow) {
            //hide  arrow
            timeToClickArrow = game.time.elapsedSecondsSince(arrow.shownTime);
            if (timeToClickArrow < 0.5) {
                var bonusText = game.add.bitmapText(game.world.centerX, game.world.centerY, 'carrier_command', getPostivePhrase(), 24);
                bonusText.anchor.setTo(0.5);
                bonusText.smoothed = false;

                game.add.tween(bonusText).to({ y: 0 }, 1500, Phaser.Easing.Linear.None, true);
                game.add.tween(bonusText).to({ alpha: 0 }, 1500, Phaser.Easing.Linear.None, true);

                successSound.play();
                currScore += 50;
            }
            else {
                successSound.play();
            }

            arrow.visible = false;
            dancer.animations.play('dance' + game.rnd.integerInRange(1, 4), 10, true);
            if (arrow.angle == -90)
                game.add.tween(dancer).to({ y: game.world.centerY + 105 }, 200).to({ y: game.world.centerY + 175 }, 200).start();
        }

        function update() {
            if (game.time.elapsedSecondsSince(gameTimer) > arrowInterval && gameRunning) {
                gameTimer = game.time.time;

                startNewMove();

                // Speed up
                if (moveCounter > 5 && moveCounter < 10) {
                    arrowInterval = 1.0;
                } else if (moveCounter > 10 && moveCounter < 15) {
                    arrowInterval = 0.8;
                } else if (moveCounter > 15 && moveCounter < 20) {
                    arrowInterval = 0.6;
                }
            }
        }


    </script>

</body>

</html>