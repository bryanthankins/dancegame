<!DOCTYPE html>
<html>

<head>
    <script src="lib/phaser.min.js"></script>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }
    </style>
    <meta name="viewport" content="initial-scale=1 user-scalable=no" />
</head>

<body>

    <script>


        var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create, update: update });

        function preload() {

            game.load.image('stage', 'assets/pics/stage.png');
            game.load.image('note', 'assets/sprites/musicnote.png');
            game.load.audio('song', ['assets/audio/space.mp3']);

            game.load.audio('start', ['assets/audio/button_start.wav']);
            game.load.audio('success', ['assets/audio/button_correct.wav']);
            game.load.audio('miss', ['assets/audio/button_fail.wav']);
            game.load.audio('end', ['assets/audio/dramatic.wav']);

            game.load.spritesheet('dancer1', 'assets/sprites/dancer1.png', 64, 64);
            game.load.spritesheet('dancer2', 'assets/sprites/dancer2.png', 64, 64);
            game.load.spritesheet('dancer3', 'assets/sprites/dancer3.png', 64, 64);

            game.load.image('portrait1', 'assets/sprites/portrait1.png');
            game.load.image('portrait2', 'assets/sprites/portrait2.png');
            game.load.image('portrait3', 'assets/sprites/portrait3.png');


            game.load.image('arrow', 'assets/sprites/arrow.png');
            game.load.image('slidearrow', 'assets/sprites/slidearrow.png');
            game.load.image('diagonalarrow', 'assets/sprites/diagonalarrow.png');
            game.load.spritesheet('kaboom', 'assets/sprites/explosion.png', 64, 64, 23);
            game.load.bitmapFont('carrier_command', 'assets/fonts/carrier_command.png', 'assets/fonts/carrier_command.xml');


        }

        var back;
        var mummy;
        var dancer;
        var anim;
        var loopText;
        var slideButtonPressed = true;
        var timer;
        var failCounter = 0;
        var arrows;
        var note;
        var arrowInterval = 1.3;
        var bmpText;
        var bmpText2;
        var startText;
        var scoreText;
        var levelText;
        var charText;
        var currScore = 0;
        var arrowShownTime;
        var timeToClickArrow;
        var slideArrowShownTime;
        var timeToClickSlideArrow;
        var slideArrows;
        var currSlideArrow;
        var startSound;
        var successSound;
        var missSound;
        var endSound;
        var gameTimer;
        var gameRunning = false;
        var moveCounter = 0;
        var simultaneousArrows = 1;
        var version = "5.8";
        var successSpeedTime = 0.37;
        var arrowPoints = 25;
        var fastClickCount = 0;
        var explosionAnimation;
        var level = 1;
        var levels;
        var versionText;

        function create() {
            // Game set-up
            gameTimer = game.time.time;
            game.input.maxPointers = 3;
            game.scale.pageAlignHorizontally = true;
            game.scale.pageAlignVertically = true;
            game.stage.backgroundColor = 0x000000;
            if (!game.device.desktop) {
                game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
                game.scale.pageAlignHorizontally = true;
                game.scale.pageAlignVertically = true;
                document.body.style.backgroundColor = '#000000';
            }

            // Add music
            music = game.add.audio('song', 0.5, true);
            startSound = game.add.audio('start');
            successSound = game.add.audio('success');
            missSound = game.add.audio('miss');
            endSound = game.add.audio('end');

            // // Background
            back = game.add.image(game.world.centerX, game.world.centerY, 'stage');
            back.anchor.setTo(0.5);
            back.smoothed = false;

            // // Add Text
            bmpText = game.add.bitmapText(this.world.centerX, this.world.centerY - 150, 'carrier_command', 'SOCIAL DISTANCE', 30);
            bmpText.smoothed = false;
            bmpText.anchor.setTo(0.5);

            bmpText2 = game.add.bitmapText(this.world.centerX, this.world.centerY - 100, 'carrier_command', 'Dancing', 25);
            bmpText2.anchor.setTo(0.5);
            bmpText2.smoothed = false;

            scoreText = game.add.bitmapText(this.world.centerX + 175, this.world.centerY - 275, 'carrier_command', 'Score: 0', 24);
            scoreText.anchor.setTo(0.5);
            scoreText.smoothed = false;
            scoreText.visible = false;

            versionText = game.add.bitmapText(this.world.centerX - 175, this.world.centerY - 275, 'carrier_command', 'Version: ' + version, 24);
            versionText.anchor.setTo(0.5);
            versionText.smoothed = false;
            versionText.visible = false;

            levelText = game.add.bitmapText(this.world.centerX - 175, this.world.centerY + 285, 'carrier_command', 'Level: ', 20);
            levelText.anchor.setTo(0.5);
            levelText.smoothed = false;
            levelText.visible = false;

            charText = game.add.bitmapText(this.world.centerX + 175, this.world.centerY + 285, 'carrier_command', 'Player: ', 20);
            charText.anchor.setTo(0.5);
            charText.smoothed = false;
            charText.visible = false;


            startText = this.add.bitmapText(this.world.centerX, this.world.centerY, 'carrier_command', 'Tap to Start', 24);
            startText.anchor.x = 0.5;
            this.add.tween(startText).to({ y: 275 }, 100).easing(Phaser.Easing.Bounce.Out).start();
            this.add.tween(startText).to({ angle: -2 }, 500).to({ angle: 2 }, 1000).to({ angle: 0 }, 500).loop().start();
            startText.inputEnabled = true;
            startText.visible = false;
            startText.events.onInputDown.add(startGame, this);
            //game.input.onDown.addOnce(startGame, this);

            // // Dancer
            dancers = game.add.group();
            dancers.create(this.world.centerX, this.world.centerY + 175, 'dancer1', 5);
            dancers.create(this.world.centerX, this.world.centerY + 175, 'dancer2', 5);
            dancers.create(this.world.centerX, this.world.centerY + 175, 'dancer3', 5);
            dancers.forEach(function (dancer) {
                dancer.anchor.setTo(0.5);
                dancer.scale.set(3);
                dancer.smoothed = false;
                dancer.visible = false;
                dancer.animations.add('dance1', [0, 1, 2, 3, 4, 5, 6, 7]);
                dancer.animations.add('dance2', [8, 9, 10, 11, 12, 13, 14, 15, 16]);
                dancer.animations.add('dance3', [17, 18, 19, 20, 21, 22, 23, 24, 25]);
                dancer.animations.add('dance4', [26, 27, 28, 29, 30, 31, 32, 33, 34]);
                dancer.frame = 0; //happy frame
            });

            // Difficulty text
            // levels = game.add.group();
            // var levelText1 = game.add.bitmapText(this.world.centerX - 245, this.world.centerY - 200, 'carrier_command', 'EASY', 20);
            // var levelText2 = game.add.bitmapText(this.world.centerX, this.world.centerY - 200, 'carrier_command', 'MED', 20);
            // var levelText3 = game.add.bitmapText(this.world.centerX + 245, this.world.centerY - 200, 'carrier_command', 'HARD', 20);
            // levels.add(levelText1);
            // levels.add(levelText2);
            // levels.add(levelText3);
            // levels.forEach(function (level) {
            //     level.smoothed = false;
            //     level.anchor.setTo(0.5);
            // });
            
            

            // explosion
            explosionAnimation = game.add.sprite(0, 0, 'kaboom');
            explosionAnimation.anchor.setTo(0.5, 0.5);
            explosionAnimation.scale.set(3);
            explosionAnimation.animations.add('kaboom');
            explosionAnimation.visible = false;

            // // Arrows
            arrows = game.add.group();
            arrows.create(this.world.centerX - 115, this.world.centerY + 150, 'arrow').angle = 180;
            arrows.create(this.world.centerX + 115, this.world.centerY + 150, 'arrow').angle = 0;
            arrows.create(this.world.centerX, this.world.centerY + 35, 'arrow').angle = -90;
            arrows.create(this.world.centerX - 205, this.world.centerY + 150, 'slidearrow').angle = 180;
            arrows.create(this.world.centerX + 205, this.world.centerY + 150, 'slidearrow').angle = 0;  
            arrows.create(this.world.centerX + 205, this.world.centerY - 110, 'diagonalarrow').angle = -45;   
            arrows.create(this.world.centerX - 205, this.world.centerY - 110, 'diagonalarrow').angle = -125;   
            arrows.forEach(function (arrow) {
                arrow.anchor.setTo(0.5, 0.5);
                arrow.visible = false;
                arrow.scale.set(1.4);
                arrow.smoothed = false;
                arrow.inputEnabled = true;
                arrow.events.onInputDown.add(arrowClick, this);

            });


            // Portraits
            portraits = game.add.group();
            portraits.create(this.world.centerX - 245, this.world.centerY - 250, 'portrait1');
            portraits.create(this.world.centerX, this.world.centerY - 250, 'portrait2');
            portraits.create(this.world.centerX + 245, this.world.centerY - 250, 'portrait3');
            portraits.forEach(function (portrait) {
                portrait.anchor.setTo(0.5);
                portrait.smoothed = false;
                portrait.scale.set(2);
                portrait.inputEnabled = true;
                portrait.events.onInputDown.add(portraitClick, this);
            });
            

        }

        function portraitClick(portrait) {
            if(dancer) {
                dancer.visible = false;
            }


            startSound.play();

            var difficultyText;
            var playerText;
            if(portrait.key == 'portrait3') {
                level = 3;
                difficultyText  = "Level: Hard";
                playerText = "Player: Bob";
            }else if(portrait.key == 'portrait2') {
                level = 2;
                difficultyText  = "Level: Med";
                playerText = "Player: Joe";
            } else {
                level = 1;
                difficultyText  = "Level: Easy";
                playerText = "Player: Sam";
            }
            
            dancer = dancers.getAt(level - 1);
            dancer.visible = true;
            dancer.animations.play('dance' + game.rnd.integerInRange(1, 4), 10, true);
            startText.visible = true;
            levelText.text = difficultyText;
            levelText.visible = true;
            charText.text = playerText;
            charText.visible = true;
        }
          

        function startGame() {

            music.play();
            portraits.forEach(function (portrait) {
                portrait.visible = false;
            });
            dancer.animations.play('dance' + game.rnd.integerInRange(1, 4), 10, true);
            back.inputEnabled = false;
            bmpText.visible = false;
            bmpText2.visible = false;
            startText.visible = false;
            scoreText.visible = true;
            versionText.visible = true;
            levelText.visible = false;
            charText.visible = false;
            startSound.play();
            gameRunning = true;

        }

        function noteClick() {
            music.pause();
        }

        function endGame() {
            gameRunning = false
            var failText = game.add.bitmapText(game.world.centerX, game.world.centerY - 70, 'carrier_command', 'GAME OVER', 44);
            failText.anchor.x = 0.5;
            dancer.animations.stop(null, true);
            dancer.frame = 7; //sad frame
            endSound.play();
            music.pause();
            moveCounter = 0;

        }

        function runMissLogic() {
                failCounter += 1;
                var missText = game.add.bitmapText(game.world.centerX, game.world.centerY, 'carrier_command', getNegativePhrase(), 24);
                missText.anchor.setTo(0.5);
                missText.smoothed = false;

                game.add.tween(missText).to({ y: 0 }, 1500, Phaser.Easing.Linear.None, true);
                game.add.tween(missText).to({ alpha: 0 }, 1500, Phaser.Easing.Linear.None, true);
                game.add.tween(missText).to({ angle: -50 }, 500).to({ angle: 50 }, 1000).to({ angle: -50 }, 500).loop().start();

                missSound.play();
        }

   

        function startNewMove() {
            moveCounter++;
            
            hasVisibleArrows = false;
            arrows.forEach(function (arrow) {
                if (arrow.visible) {
                    hasVisibleArrows = true;
                    arrow.visible = false;
                }
            });

            if (hasVisibleArrows) {
                runMissLogic();
                if (failCounter > 2) {
                    endGame();
                }
            }
            else {
                failCounter = 0;
                currScore += arrowPoints;
                scoreText.text = 'Score:' + currScore;
            }

            // Get new random arrow and show
            var newArrow = arrows.getRandom();
            newArrow.visible = true;
            newArrow.shownTime = game.time.time;
            
            if(simultaneousArrows > 1 && game.rnd.integerInRange(1,3) == 2){
                var secondArrow = arrows.getRandom();
                secondArrow.visible = true;
                secondArrow.shownTime = game.time.time;
            }

            if(simultaneousArrows > 2 && game.rnd.integerInRange(1,2) == 2){
                var thirdArrow = arrows.getRandom();
                thirdArrow.visible = true;
                thirdArrow.shownTime = game.time.time;
            }
            if(simultaneousArrows > 3 && game.rnd.integerInRange(1,2) == 2){
                var fourthArrow = arrows.getRandom();
                fourthArrow.visible = true;
                fourthArrow.shownTime = game.time.time;
            }

        }


        function getPostivePhrase() {
            var positivePhrase = [
                "AWESOME!",
                "NICE!",
                "Oh Yeah!",
                "Rock on!",
                "Woah! Nice!",
                "Beast Mode!"
            ];

            var randomNum = game.rnd.integerInRange(0, 5);
            return positivePhrase[randomNum];

        }


        function getNegativePhrase() {
            var positivePhrase = [
                "BOO!",
                "SAD!",
                "Umm...!",
                "FAIL!",
                "You Suck!",
                "Off Beat!"
            ];

            var randomNum = game.rnd.integerInRange(0, 5);
            return positivePhrase[randomNum];

        }

        function arrowClick(arrow) {
            //hide  arrow
            timeToClickArrow = game.time.elapsedSecondsSince(arrow.shownTime);
            if (timeToClickArrow < successSpeedTime) {
                var bonusText = game.add.bitmapText(game.world.centerX, game.world.centerY, 'carrier_command', getPostivePhrase(), 24);
                bonusText.anchor.setTo(0.5);
                bonusText.smoothed = false;

                game.add.tween(bonusText).to({ y: 0 }, 1500, Phaser.Easing.Linear.None, true);
                game.add.tween(bonusText).to({ alpha: 0 }, 1500, Phaser.Easing.Linear.None, true);
              
                currScore += 50;
                fastClickCount += 1;
                if (fastClickCount >= 3) {
                    //game.input.onDown.add(particleBurst, this);
                    fastClickCount  = 0;
                    explosionAnimation.visible = true;
                    explosionAnimation.reset(arrow.x, arrow.y);
                    explosionAnimation.play('kaboom', 30, false, true);

                } else {
                   // game.input.onDown.remove(particleBurst, this);
                }


            }
            else {
                fastClickCount  = 0;                
            }

            successSound.play();


            arrow.visible = false;
            dancer.animations.play('dance' + game.rnd.integerInRange(1, 4), 10, true);
            if (arrow.key == 'slidearrow') {
                var slideOffset = 0;
                var rotateOffset = 0;
                if (arrow.angle == 0) {
                    slideOffset = 200;
                    rotateOffset = 15
                }
                else {
                    slideOffset = -200;
                    rotateOffset = -15
                }
                game.add.tween(dancer).to({ x: game.world.centerX + slideOffset }, 500).to({ x: game.world.centerX }, 500).start();
                game.add.tween(dancer).to({ angle: rotateOffset }, 500).to({ angle: 2 }, 500).to({ angle: 0 }, 500).start();
            }
            else if(arrow.key == 'diagonalarrow'){
                if(arrow.angle == -45){
                    game.add.tween(dancer).to({ angle: 360 }, 500).start();
                } else {
                    game.add.tween(dancer).to({ angle: -360 }, 500).start();
                }
            } else if (arrow.angle == -90) {
                game.add.tween(dancer).to({ y: game.world.centerY + 105 }, 200).to({ y: game.world.centerY + 175 }, 200).start();
            }
        }

        function update() {
            if (game.time.elapsedSecondsSince(gameTimer) > arrowInterval && gameRunning) {
                gameTimer = game.time.time;

                startNewMove();

                // Speed up & Add more arrows
                if (currScore > 500 && currScore < 1500) {
                    arrowInterval = 1.1;
                } else if (currScore > 1500 && currScore < 2500) {
                    arrowInterval = 1.0;
                    simultaneousArrows = 2;
                } else if (currScore > 3500 && currScore < 4000) {
                    arrowInterval = 0.8;
                    simultaneousArrows = 3;
                } else if (currScore > 4000) {
                    arrowInterval = 0.7;
                    simultaneousArrows = 4;
                }
            }
        }


    </script>

</body>

</html>
