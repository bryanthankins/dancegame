<!DOCTYPE html>
<html>

<head>
    <script src="lib/phaser.min.js"></script>
    <style type="text/css">
		* { margin: 0; padding: 0; }
	</style>
<meta name="viewport" content="initial-scale=1 user-scalable=no" />
</head>

<body>

    <script>
       

    var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('stage', 'assets/pics/stage.png');
    game.load.image('note', 'assets/sprites/musicnote.png');
    game.load.audio('song', ['assets/audio/space.mp3']);
    game.load.spritesheet('dancer', 'assets/sprites/dancer.png', 64, 64);
    game.load.image('arrow', 'assets/sprites/arrow.png');
    game.load.bitmapFont('carrier_command', 'assets/fonts/carrier_command.png', 'assets/fonts/carrier_command.xml');


}

var back;
var mummy;
var dancer;
var anim;
var loopText;
var buttonPressed = true;
var timer;
var failCounter = 0;
var arrows;
var note;
var arrowInterval = 1000;
var currArrow;
var bmpText;
var bmpText2;
var startText;
var scaleRatio = window.devicePixelRatio / 3;

function create() {
   // game.input.maxPointers = 1;
    game.scale.pageAlignHorizontally = true;
    game.scale.pageAlignVertically = true;
    game.stage.backgroundColor = 0x000000;
    if (!game.device.desktop) {
			game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
		    //game.scale.setMinMax(game.width/2, game.height/2, game.width*2, game.height*2);
			game.scale.pageAlignHorizontally = true; 
			game.scale.pageAlignVertically = true;
            document.body.style.backgroundColor = '#000000';
		}
    
    // Add music
     music = game.add.audio('song');  
 
    // // Background
    back = game.add.image(game.world.centerX, game.world.centerY, 'stage');
    back.anchor.setTo(0.5);
    back.smoothed = false;

    // // Add Text
    bmpText = game.add.bitmapText(this.world.centerX, this.world.centerY - 150, 'carrier_command','SOCIAL DISTANCE',30);
    bmpText.smoothed = false;
    bmpText.anchor.setTo(0.5);
    bmpText2 = game.add.bitmapText(this.world.centerX, this.world.centerY - 100, 'carrier_command','Dancing',25);
    bmpText2.anchor.setTo(0.5);
    bmpText2.smoothed = false;

    startText = this.add.bitmapText(this.world.centerX, 230, 'carrier_command', 'Tap to Start', 24);
    startText.anchor.x = 0.5;
    this.add.tween(startText).to({y: 275},100).easing(Phaser.Easing.Bounce.Out).start();
    this.add.tween(startText).to({angle: -2}, 500).to({angle: 2}, 1000).to({angle: 0}, 500).loop().start();
    startText.inputEnabled = true;
	game.input.onDown.addOnce(startGame, this);

    // // Dancer
    dancer = game.add.sprite(this.world.centerX, this.world.centerY + 175, 'dancer', 5);
    dancer.anchor.setTo(0.5);
    dancer.scale.set(3);
    dancer.smoothed = false;
    dancer.animations.add('dance1',[0,1,2,3,4,5,6,7]);    
    dancer.animations.add('dance2',[8,9,10,11,12,13,14,15,16]);
    dancer.animations.add('dance3',[17,18,19,20,21,22,23,24,25]);
    dancer.animations.add('dance4',[26,27,28,29,30,31,32,33,34]);
    dancer.frame = 0; //happy frame

    // // Arrows
    arrows = game.add.group();
    arrows.create(225, 400, 'arrow').angle = 180;
    arrows.create(425, 400, 'arrow').angle = 0;
    arrows.create(320, 290, 'arrow').angle = -90;    
    arrows.forEach(function(arrow){
            arrow.anchor.setTo(0.5, 0.5);
            arrow.visible = false;
            arrow.smoothed = false;
            arrow.inputEnabled = true;
            arrow.events.onInputDown.add(arrowClick, this);
        
    }); 

    // // Music note
    note = game.add.sprite(this.world.centerX - 265, this.world.centerY + 280, 'note');
    note.anchor.setTo(0.5);
    note.inputEnabled = true;
    note.events.onInputDown.add(noteClick, this);

   
}

function startGame() {
    
    //music.play();
    dancer.animations.play('dance' + game.rnd.integerInRange(1, 4),10,true);
    back.inputEnabled = false;
    bmpText.visible = false;
    bmpText2.visible = false;
    startText.visible = false;
    // Game loop
    timer = game.time.events.loop(arrowInterval, startNewMove, this);    
    
}

function noteClick() {
    music.pause();
}



function startNewMove() {
    //Show arrow 
    if(currArrow)   
        currArrow.visible = false;
    currArrow = arrows.getRandom();
    currArrow.visible = true;

    if(!buttonPressed)
    {
        failCounter +=1;
        if(failCounter > 2) 
        {
            game.time.events.remove(timer);
 
	        var failText = this.add.bitmapText(this.world.centerX, this.world.centerY - 70, 'carrier_command', 'GAME OVER', 44);
            failText.anchor.x = 0.5;
            dancer.animations.stop(null, true);
            dancer.frame = 7; //sad frame
            currArrow.visible = false;
        }

        buttonPressed = true;
    }
    else
    {
        buttonPressed = false;
    }
    

}

function arrowClick (arrow) {

    //hide  arrow
    arrow.visible = false;
    buttonPressed = true;
    console.log('success!');    
    dancer.animations.play('dance' + game.rnd.integerInRange(1, 4),10,true);
}

function update() {

}
    </script>

</body>

</html>